<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <title>Traffic 1</title>
    <script type="text/javascript"
            src = "simpleGame.js"></script>
    
    <script type="text/javascript">
        var game;
        var slowCar, fastCar;
        var LANE_ONE = 37.5;
        var LANE_TWO = 112.5;
        var LANE_THREE = 187.5;
        var LANE_FOUR = 262.5;
        var FOLLOW_MULT = 80; //follow distance is given in car lengths, must multiply by factor
    
    function Car(carID, startLane, desiredLane, speed, desiredSpeed, followDist, waitTime)
    { 
        car = new Sprite(scene, "car.jpg", 75,40);
        car.setAngle(90);
        car.setImgAngle(0);
        car.maxSpeed = 5;
        car.minSpeed = 0;
        car.desiredSpeed = desiredSpeed;
        car.accel = .5;
        car.decel = -.75;
        car.spawned = false;
        
        car.carID = carID;
        car.Lane = startLane;
        car.followDist = (followDist*FOLLOW_MULT) + 38; // car lengths times length of car plus half of car length
        car.setSpeed(0);
        car.setPosition(10,startLane);
        
        //return current lane of caar
        car.getLane = function()
        {
            return car.Lane;
        }
        
        //checking if the car can/should accelerate
        car.accel = function()
        {
            //console.log("accel");
            car.changeSpeedBy(car.accel);
        } //end accel
        
        //checking if the car should decel
        car.decel = function()
        {
            //if the dist to next car is approaching the following distance
            //  but is still greater than goal follow distance
            
            car.changeSpeedBy(car.decel);
            //console.log("decel");
            
            if(car.speed < 0)
            {
                car.setSpeed(0);
            }
        } //end decel
        
        //*************************************
        //This implements waitTime before setting a car to be visible, and
        //  use tooClose to track the car in front
        //*************************************
        car.spawnAndTrack = function()
        {
            //wait until car is supposed to spawn
            if(timer.getElapsedTime() > car.waitTime)
            {
                //first time spawning of car
                if(car.spawned == false)
                {
                    car.visible = true;
                    car.setSpeed(car.desiredSpeed);
                    car.spawned = true;
                }
                
                //console.log(car.carID + " speed: " + car.speed);
                
                //calculate what car is first in front of this car
                carInFront = findCarInFront(car);
                
                if(carInFront != null)
                {
                    //check if carInFront is too close
                    if(car.tooClose(carInFront))
                    {
                        //console.log("too close");
                        //too close, slows car down
                        if(car.speed > 0)
                        {
                            car.changeSpeedBy(-.1);
                        }
                        
                        //makes sure car doesn't go backward
                        if(car.speed < 0)
                        {
                            car.setSpeed(0);
                        }
                        
                        
                    } else if(car.speed < car.desiredSpeed)
                    {
                        //speeds up if desired speed isn't reached
                        car.changeSpeedBy(.1);
                    }
                }
            } //end tracking
        } //end spawnAndTrack
        
        
        //*****************************************************
        //  Find and return the car directly in front of the 
        //      car given as parameter
        //*****************************************************
        
        car.findCarInFront = function(dude)
        {
            //default value
            carInFront = null;
            
            //iterate through sprite list
            for(var i = 0; i < spriteList.length(); i++)
            {
                //pull the sprite from sprite list
                check = spriteList.returnSprite(i);
                
                //if they are in the same lane
                if(check.y == dude.Lane)
                {
                    //if the other car is in front
                    if(check.x > dude.x)
                    {
                        carInFront = check;
                    }
                }
            }
            return carInFront;
        }
        
        //*****************************************************
        //  Determines if this car is too to car in front
        //       
        //*****************************************************
    
        car.tooClose = function(sprite){
            //check if the car is too close to the one in front
            close = false;
            
            //both must be visible
            if(this.visible)
            {
                //console.log("dis is visible");
                
                if(sprite.visible)
                {
                    //console.log("both visible");
                    
                    //the two have to be in the same lane
                    if(sprite.Lane == this.Lane)
                    {
                        //console.log("in the same lane");
                        //if this car is closer than 2* the follow dist
                        //  AND this car's speed is still greater than the one in front
                        if((this.followDist + 38) > (sprite.x-this.x) && this.speed > sprite.speed)
                        {
                            close = true;
                            //this.decel();
                            //console.log("too close");
                        }
                    }
                }
            }
            
            return close;
        } //end too close
        
        return car;
    }
    
    function Road()
    {
        road = new Sprite(scene, "road.png",800,300);
        road.setPosition(400,150);
    }
    
    function init()
    {
        game = new Scene();
        game.setSize(1300,300);
        timer = new Timer();
        
        road = new Road();
        
        //carID, startLane, desiredLane, speed, desiredSpeed, followDist, waitTime
        fastCar = new Car(1, LANE_TWO, LANE_TWO, 0, 5, 1, 8);
        fastCar.setBoundAction(DIE);
        fastCar.visible = false;
        
        lastCar = new Car(1, LANE_TWO, LANE_TWO, 0, 6, 1, 12);
        lastCar.setBoundAction(DIE);
        lastCar.visible = false;
        
        slowCar = new Car(2, LANE_TWO, LANE_TWO, 2.5, 4, 1, 0);
        slowCar.setBoundAction(DIE);
        
        otherCar = new Car(2, LANE_THREE, LANE_THREE, 3, 3, 1, 0);
        otherCar.setBoundAction(DIE);
        
        game.start();
    }
    
    function update()
    {
        game.clear();
        
        if(timer.getElapsedTime() > 8 && timer.getElapsedTime() < 8.1)
        {
            fastCar.visible = true;
            fastCar.setSpeed(fastCar.desiredSpeed);
        }
        
        if(timer.getElapsedTime() > 11 && timer.getElapsedTime() < 11.1)
        {
            lastCar.visible = true;
            lastCar.setSpeed(fastCar.desiredSpeed);
        }
        
        //start tracking fastCar after 10 ticks
        if(timer.getElapsedTime() > 8)
        {
            //console.log("Car speed: " + fastCar.speed);
            
            //check if fastCar is too close
            if(fastCar.tooClose(slowCar))
            {
                //console.log("too close");
                //too close, slows car down
                if(fastCar.speed > 0)
                {
                    fastCar.changeSpeedBy(-.1);
                }
                
                //makes sure car doesn't go backward
                if(fastCar.speed < 0)
                {
                    fastCar.setSpeed(0);
                }
                
                
            } else if(fastCar.speed < fastCar.maxSpeed)
            {
                //speeds up if max speed isn't reached
                fastCar.changeSpeedBy(.1);
            }
        } //end tracking of fastCar
        
        if(timer.getElapsedTime() > 11)
        {
            //console.log("Car speed: " + fastCar.speed);
            
            //check if lastCar is too close
            if(lastCar.tooClose(fastCar))
            {
                //console.log("too close");
                //too close, slows car down
                if(lastCar.speed > 0)
                {
                    lastCar.changeSpeedBy(-.1);
                }
                
                //makes sure car doesn't go backward
                if(lastCar.speed < 0)
                {
                    lastCar.setSpeed(0);
                }
                
                
            } else if(lastCar.speed < lastCar.maxSpeed)
            {
                //speeds up if max speed isn't reached
                //console.log("can speed up");
                lastCar.changeSpeedBy(.1);
            }
        } //end tracking of lastCar
        
        //console.log("Time: " + timer.getElapsedTime());
        spriteList.update();
    }
    </script>
</head>

<body onload="init()">
    
</body>

</html>